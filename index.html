<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BD Clean Jurain - Registration (Final)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--primary:#00695c;--secondary:#4db6ac;--danger:#d32f2f;--success:#2e7d32;--muted:#6c757d}
    *{box-sizing:border-box;font-family: "Noto Sans Bengali", "Segoe UI", sans-serif}
    body{margin:0;background:linear-gradient(135deg,#e0f7fa 0%,#fff 100%);padding:16px;min-height:100vh}
    header{background:var(--primary);color:#fff;padding:14px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;box-shadow:0 4px 12px rgba(0,0,0,0.12)}
    .header-left h1{font-size:18px;display:flex;align-items:center;gap:10px}
    .header-right{display:flex;align-items:center;gap:12px;font-size:14px}
    .btn-sm{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .login-btn{background:rgba(255,255,255,0.12);color:#fff}
    .logout-btn{background:rgba(255,255,255,0.12);color:#fff;display:none}

    .main{display:flex;gap:20px;align-items:flex-start;justify-content:center;margin-top:18px}
    .container{width:100%;max-width:820px;background:#fff;padding:22px;border-radius:12px;box-shadow:0 15px 30px rgba(0,0,0,0.08);position:relative}
    .container::before{content:'';position:absolute;left:0;top:0;width:100%;height:6px;background:linear-gradient(90deg,var(--primary),var(--secondary));border-top-left-radius:12px;border-top-right-radius:12px}
    h2{color:var(--primary);text-align:center;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
    .header-info{display:flex;justify-content:center;gap:14px;color:#555;margin-bottom:14px;flex-wrap:wrap}

    .progress-bar{height:8px;background:#eee;border-radius:999px;margin-bottom:14px;overflow:hidden}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .35s}

    .form-page{display:none}
    .form-page.active{display:block}

    .form-group{margin-bottom:14px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#444}
    input[type=text],input[type=tel],input[type=email],input[type=url],select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;background:#fbfbfb;font-size:15px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,105,92,0.06);background:#fff}
    .error-text{color:var(--danger);font-size:13px;margin-top:6px;display:none}
    .invalid input,.invalid select{border-color:var(--danger)}

    .btn{width:100%;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#f1f1f1;color:#333}
    .btn-inline{width:auto;padding:10px 16px}

    .photo-preview{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid #eee;margin-bottom:12px;display:none}
    .upload-btn{display:inline-block;padding:10px 16px;border-radius:6px;background:var(--primary);color:#fff;position:relative;cursor:pointer}
    .upload-btn input{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}

    .terms{background:#fafafa;border:1px solid #eee;padding:12px;border-radius:8px;font-size:14px;max-height:150px;overflow:auto}

    .footer{text-align:center;color:#666;margin-top:12px}

    /* Admin panel */
    .admin-panel{display:none;width:100%}
    .dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:14px 0}
    .stat-card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 5px rgba(0,0,0,0.05);text-align:center}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .search-box{position:relative;flex:1;min-width:220px}
    .search-box input{padding:10px 14px 10px 38px}
    .search-box i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .filter-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .filter-btn{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

    .table-container{background:#fff;padding:12px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.08);overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border:1px solid #eee;text-align:center}
    thead th{position:sticky;top:0;background:var(--primary);color:#fff}

    .action-buttons{display:flex;gap:6px;justify-content:center}
    .action-btn{padding:6px 8px;border-radius:6px;border:none;color:#fff;cursor:pointer}

    /* modal */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:18px;border-radius:8px;width:520px;max-width:95%;max-height:90vh;overflow:auto}

    .toast{position:fixed;right:18px;bottom:18px;padding:12px 16px;border-radius:6px;color:#fff;display:flex;align-items:center;gap:10px;z-index:1100;transform:translateY(20px);opacity:0;transition:.3s}
    .toast.show{opacity:1;transform:none}
    .toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.warning{background:var(--secondary)}

    @media(max-width:900px){header{flex-direction:column;align-items:flex-start} .container{padding:16px}}
  </style>
</head>
<body>
  <header>
    <div class="header-left"><h1><i class="fas fa-broom"></i> BD Clean Jurain</h1></div>
    <div class="header-right">
      <div id="dateTime" aria-live="polite"></div>
      <div id="ipAddress" aria-live="polite"></div>
      <button id="loginButton" class="btn-sm login-btn" onclick="openLoginModal()"><i class="fas fa-sign-in-alt"></i> Login</button>
      <button id="logoutButton" class="btn-sm logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <main class="main">
    <!-- Registration container -->
    <section class="container" id="registrationForm" aria-labelledby="formTitle">
      <h2 id="formTitle"><i class="fas fa-broom"></i> ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®</h2>

      <div class="header-info">
        <div id="date"><i class="fas fa-calendar-alt"></i> <span></span></div>
        <div id="time"><i class="fas fa-clock"></i> <span></span></div>
        <div id="ip"><i class="fas fa-globe"></i> <span></span></div>
      </div>

      <div class="progress-bar" aria-hidden="true"><div id="formProgress" class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div></div>

      <form id="userForm" novalidate>
        <!-- Page 1 -->
        <div id="page1" class="form-page active">
          <div class="form-group" id="group-name">
            <label for="name">‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ</label>
            <input id="name" type="text" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required aria-required="true">
            <div class="error-text">‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</div>
          </div>

          <div class="form-group" id="group-phone">
            <label for="phone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
            <input id="phone" type="tel" placeholder="01XXXXXXXXX" required aria-required="true">
            <div class="error-text">‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂)</div>
          </div>

          <div class="form-group" id="group-email">
            <label for="email">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
            <input id="email" type="email" placeholder="example@gmail.com">
            <div class="error-text">‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</div>
          </div>

          <button type="button" class="btn btn-inline" onclick="nextPage(1,2)">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- Page 2 -->
        <div id="page2" class="form-page">
          <div class="form-group" id="group-area">
            <label for="area">‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input id="area" type="text" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
            <div class="error-text">‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</div>
          </div>

          <div class="form-group" id="group-word">
            <label for="word">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
            <input id="word" type="text" placeholder="‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
            <div class="error-text">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</div>
          </div>

          <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
            <button type="button" class="btn secondary btn-inline" onclick="nextPage(2,1)"><i class="fas fa-arrow-left"></i> ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
            <button type="button" class="btn btn-inline" onclick="nextPage(2,3)">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <!-- Page 3 -->
        <div id="page3" class="form-page">
          <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:12px">
            <img id="photoPreview" class="photo-preview" alt="‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡¶ï‡ßÉ‡¶§ ‡¶õ‡¶¨‡¶ø">
            <label class="upload-btn"> <i class="fas fa-camera"></i> ‡¶´‡¶ü‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
              <input id="photo" type="file" accept="image/*">
            </label>
            <div class="error-text" id="photoError">‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶ü‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)</div>
          </div>

          <div class="form-group" id="group-facebook">
            <label for="facebook">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)</label>
            <input id="facebook" type="url" placeholder="https://facebook.com/username" required>
            <div class="error-text">‡¶∏‡¶†‡¶ø‡¶ï Facebook URL ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡ßü)</div>
          </div>

          <div class="terms" aria-label="Terms and conditions">
            <h4><i class="fas fa-info-circle"></i> ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ ‡¶ì ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</h4>
            <p>‡ßß. ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶®‡¶æ‡¶ó‡¶∞‡¶ø‡¶ï ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
            <p>‡ß®. ‡¶™‡ßç‡¶∞‡¶¶‡¶§‡ßç‡¶§ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ì ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
            <p>‡ß©. ‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Ø‡¶º‡¶≠‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞‡•§</p>
            <p>‡ß™. ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶¨‡¶æ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞ BD Clean Jurain ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§</p>
          </div>

          <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px">
            <button type="button" class="btn secondary btn-inline" onclick="nextPage(3,2)"><i class="fas fa-arrow-left"></i> ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
            <button type="button" class="btn btn-inline" onclick="validateForm()"><i class="fas fa-paper-plane"></i> ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
          </div>
        </div>
      </form>

      <div id="successMessage" class="message success" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:#d4edda;color:#155724">‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</div>
      <div id="errorMessage" class="message error" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:#f8d7da;color:#721c24"></div>

      <div class="footer">BD Clean Jurain &copy; <span id="year"></span> | ‡¶∏‡¶ï‡¶≤ ‡¶Ö‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</div>
    </section>

    <!-- Admin panel -->
    <aside class="admin-panel" id="adminPanel">
      <div class="dashboard-stats">
        <div class="stat-card"><i class="fas fa-users"></i><h3 id="totalUsers">0</h3><p>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</p></div>
        <div class="stat-card"><i class="fas fa-clock"></i><h3 id="pendingUsers">0</h3><p>Pending</p></div>
        <div class="stat-card"><i class="fas fa-check-circle"></i><h3 id="approvedUsers">0</h3><p>Approved</p></div>
        <div class="stat-card"><i class="fas fa-times-circle"></i><h3 id="rejectedUsers">0</h3><p>Rejected</p></div>
      </div>

      <div class="controls">
        <div class="search-box"><i class="fas fa-search"></i><input id="searchInput" placeholder="Search users..."></div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="pending">Pending</button>
          <button class="filter-btn" data-filter="approved">Approved</button>
          <button class="filter-btn" data-filter="rejected">Rejected</button>
        </div>
      </div>

      <div class="table-container"><table id="userTable"><thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Email</th><th>Area</th><th>Word</th><th>Photo</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
    </aside>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h3>Edit User</h3><button class="close-btn" onclick="closeModal()">&times;</button></div>
      <div class="form-group"><label for="editName">Name</label><input id="editName" type="text"></div>
      <div class="form-group"><label for="editPhone">Phone</label><input id="editPhone" type="text"></div>
      <div class="form-group"><label for="editGmail">Email</label><input id="editGmail" type="text"></div>
      <div class="form-group"><label for="editArea">Area</label><input id="editArea" type="text"></div>
      <div class="form-group"><label for="editWord">Word</label><input id="editWord" type="text"></div>
      <div class="form-group"><label for="editPhoto">Photo URL</label><input id="editPhoto" type="text"></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button class="btn secondary btn-inline" onclick="closeModal()">Cancel</button><button class="btn btn-inline" onclick="saveEdit()">Save</button></div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h3>Admin Login</h3><button class="close-btn" onclick="closeLoginModal()">&times;</button></div>
      <div class="form-group"><label for="username">Username</label><input id="username" type="text"></div>
      <div class="form-group"><label for="password">Password</label><input id="password" type="password"></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button class="btn secondary btn-inline" onclick="closeLoginModal()">Cancel</button><button class="btn btn-inline" onclick="login()">Login</button></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"><i id="toast-icon"></i><span id="toast-message"></span></div>

  <script>
    // ---------- IMPORTANT: Move sensitive tokens to server in production ----------
    const ADMIN_CREDENTIALS = {username: 'jurain', password: 'jurain123'}; // change if needed

    // Put your bot token & chat IDs here (for dev/testing). Production: proxy these on server.
    const TELEGRAM_CONFIG = {
      BOT_TOKEN: '7757315317:AAHhlhX7UwuOnqSGE7C3PihIJCN-d_Gpbc4', // <-- paste your BOT token here for quick test (NOT recommended for production)
      REGISTRATION_CHAT_ID: '-1002376799447', // <-- registration messages go here
      ADMIN_CHAT_ID: '-1002376799447' // <-- admin notifications (optional)
    };

    const nowYear = new Date().getFullYear(); document.getElementById('year').textContent = nowYear;

    // App state
    let users = JSON.parse(localStorage.getItem('users') || '[]');
    let editUserId = null; let currentFilter = 'all'; let searchQuery = '';
    let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

    function init(){
      updateDateTime(); setInterval(updateDateTime,1000);
      fetchIPAddress(); setupEventListeners(); renderBasedOnLogin(); updateStats();
      document.getElementById('photo').addEventListener('change',handlePhotoChange);
    }

    function updateDateTime(){
      const now = new Date();
      document.getElementById('dateTime').innerHTML = `<i class="fas fa-calendar-alt"></i> ${now.toLocaleDateString()} <i class="fas fa-clock"></i> ${now.toLocaleTimeString()}`;
      document.querySelector('#date span').textContent = now.toLocaleDateString('bn-BD');
      document.querySelector('#time span').textContent = now.toLocaleTimeString('bn-BD');
    }

    function fetchIPAddress(){
      fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{
        document.getElementById('ipAddress').innerHTML = `<i class="fas fa-globe"></i> IP: ${d.ip}`;
        document.querySelector('#ip span').textContent = d.ip;
      }).catch(()=>{document.getElementById('ipAddress').textContent='IP: Unable to fetch';document.querySelector('#ip span').textContent='IP ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'})
    }

    function setupEventListeners(){
      document.querySelectorAll('.filter-btn').forEach(btn=>btn.addEventListener('click',function(){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');currentFilter=this.dataset.filter;renderTable();}));
      const s = document.getElementById('searchInput'); if(s){s.addEventListener('input',e=>{searchQuery=e.target.value.trim().toLowerCase();renderTable();})}
    }

    function openLoginModal(){document.getElementById('loginModal').style.display='flex';document.getElementById('loginModal').setAttribute('aria-hidden','false')}
    function closeLoginModal(){document.getElementById('loginModal').style.display='none';document.getElementById('loginModal').setAttribute('aria-hidden','true');document.getElementById('username').value='';document.getElementById('password').value=''}
    function login(){const u=document.getElementById('username').value.trim();const p=document.getElementById('password').value; if(u===ADMIN_CREDENTIALS.username && p===ADMIN_CREDENTIALS.password){isLoggedIn=true;localStorage.setItem('isLoggedIn','true');renderBasedOnLogin();closeLoginModal();showToast('Login successful','success')}else{showToast('Invalid username or password','error')}}
    function logout(){isLoggedIn=false;localStorage.setItem('isLoggedIn','false');renderBasedOnLogin();showToast('Logged out','success')}

    function renderBasedOnLogin(){if(isLoggedIn){document.getElementById('registrationForm').style.display='none';document.getElementById('adminPanel').style.display='block';document.getElementById('loginButton').style.display='none';document.getElementById('logoutButton').style.display='inline-flex';renderTable();updateStats()}else{document.getElementById('registrationForm').style.display='block';document.getElementById('adminPanel').style.display='none';document.getElementById('loginButton').style.display='inline-flex';document.getElementById('logoutButton').style.display='none'}}

    function findUserIndexById(id){return users.findIndex(u=>u.id===id)}

    function renderTable(){
      const tbody = document.querySelector('#userTable tbody'); if(!tbody) return; tbody.innerHTML='';
      const filtered = users.filter(u=>{
        const matchesFilter = currentFilter==='all' || (u.status && u.status.toLowerCase()===currentFilter);
        const q = searchQuery;
        if(!q) return matchesFilter;
        return (u.name||'').toLowerCase().includes(q) || (u.phone||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q) || (u.area||'').toLowerCase().includes(q) || (u.word||'').toLowerCase().includes(q);
      });
      if(filtered.length===0){tbody.innerHTML='<tr><td colspan="10">No users found</td></tr>';return}
      filtered.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${u.id}</td>
                        <td>${escapeHtml(u.name)}</td>
                        <td>${escapeHtml(u.phone)}</td>
                        <td>${escapeHtml(u.email||'‚Äî')}</td>
                        <td>${escapeHtml(u.area)}</td>
                        <td>${escapeHtml(u.word)}</td>
                        <td><img src="${u.photo||'https://via.placeholder.com/50'}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"></td>
                        <td class="status-${(u.status||'').toLowerCase()}">${escapeHtml(u.status||'pending')}</td>
                        <td>${escapeHtml(u.date)}</td>
                        <td class="action-buttons">
                          <button class="action-btn" title="Approve" style="background:${'#2e7d32'}" onclick="updateStatusById(${u.id},'approved')"><i class="fas fa-check"></i></button>
                          <button class="action-btn" title="Hold" style="background:${'#ff9800'}" onclick="updateStatusById(${u.id},'hold')"><i class="fas fa-pause"></i></button>
                          <button class="action-btn" title="Reject" style="background:${'#d32f2f'}" onclick="updateStatusById(${u.id},'rejected')"><i class="fas fa-times"></i></button>
                          <button class="action-btn" title="Edit" style="background:${'#1976d2'}" onclick="openEditModalById(${u.id})"><i class="fas fa-edit"></i></button>
                          <button class="action-btn" title="Delete" style="background:${'#6c757d'}" onclick="deleteUserById(${u.id})"><i class="fas fa-trash"></i></button>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    function updateStatusById(id,status){
      const idx=findUserIndexById(id);
      if(idx===-1){showToast('User not found','error');return}
      const user=users[idx]; const prev=user.status||'pending';
      user.status=status; localStorage.setItem('users',JSON.stringify(users)); renderTable(); updateStats();
      const message = `*BD Clean Jurain - Status Update*\nName: ${user.name}\nPhone: ${user.phone}\nStatus: ${prev} -> ${status}`;
      sendToTelegram(message, TELEGRAM_CONFIG.ADMIN_CHAT_ID);
      showToast('User status updated','success');
    }

    function openEditModalById(id){
      const idx=findUserIndexById(id); if(idx===-1) return;
      const u=users[idx];
      document.getElementById('editName').value=u.name;document.getElementById('editPhone').value=u.phone;document.getElementById('editGmail').value=u.email;document.getElementById('editArea').value=u.area;document.getElementById('editWord').value=u.word;document.getElementById('editPhoto').value=u.photo||'';
      editUserId=id; document.getElementById('editModal').style.display='flex'; document.getElementById('editModal').setAttribute('aria-hidden','false');
    }
    function closeModal(){document.getElementById('editModal').style.display='none';document.getElementById('editModal').setAttribute('aria-hidden','true'); editUserId=null}

    function saveEdit(){
      if(editUserId===null) return; const idx=findUserIndexById(editUserId); if(idx===-1) return;
      const original = {...users[idx]};
      users[idx].name=document.getElementById('editName').value.trim();
      users[idx].phone=document.getElementById('editPhone').value.trim();
      users[idx].email=document.getElementById('editGmail').value.trim();
      users[idx].area=document.getElementById('editArea').value.trim();
      users[idx].word=document.getElementById('editWord').value.trim();
      users[idx].photo=document.getElementById('editPhoto').value.trim();
      users[idx].status='edited';
      localStorage.setItem('users',JSON.stringify(users)); renderTable(); updateStats(); closeModal();
      const message = `*BD Clean Jurain - Edited*\nName: ${original.name} -> ${users[idx].name}`;
      sendToTelegram(message, TELEGRAM_CONFIG.ADMIN_CHAT_ID);
      showToast('User updated','success');
    }

    function deleteUserById(id){
      if(!confirm('Are you sure to delete?')) return;
      const idx=findUserIndexById(id); if(idx===-1) return;
      const removed = users.splice(idx,1)[0]; localStorage.setItem('users',JSON.stringify(users)); renderTable(); updateStats();
      const message = `*BD Clean Jurain - Deleted*\nName: ${removed.name}`;
      sendToTelegram(message, TELEGRAM_CONFIG.ADMIN_CHAT_ID);
      showToast('Deleted','success');
    }

    function updateStats(){
      document.getElementById('totalUsers').textContent = users.length;
      document.getElementById('pendingUsers').textContent = users.filter(u=> (u.status||'').toLowerCase()==='pending').length;
      document.getElementById('approvedUsers').textContent = users.filter(u=> (u.status||'').toLowerCase()==='approved').length;
      document.getElementById('rejectedUsers').textContent = users.filter(u=> (u.status||'').toLowerCase()==='rejected').length;
    }

    // Toast helper
    function showToast(msg,type='success'){
      const t = document.getElementById('toast'); const icon = document.getElementById('toast-icon'); const text = document.getElementById('toast-message');
      if(type==='success') icon.className='fas fa-check-circle'; else if(type==='error') icon.className='fas fa-exclamation-circle'; else icon.className='fas fa-exclamation-triangle';
      text.textContent = msg; t.className = `toast ${type} show`;
      setTimeout(()=>{t.className='toast'},3000);
    }

    // Navigation pages & validation
    function nextPage(current,next){
      if(current===1 && !validatePage1()) return;
      if(current===2 && !validatePage2()) return;
      document.getElementById('page'+current).classList.remove('active');
      document.getElementById('page'+next).classList.add('active');
      const widths = {1:0,2:50,3:100}; document.getElementById('formProgress').style.width = widths[next] + '%';
    }

    function validatePage1(){
      let ok=true;
      const name=document.getElementById('name'), phone=document.getElementById('phone'), email=document.getElementById('email');
      if(!name.value.trim()){document.getElementById('group-name').classList.add('invalid'); ok=false} else document.getElementById('group-name').classList.remove('invalid');
      const phoneRegex = /^01[3-9]\d{8}$/;
      if(!phoneRegex.test(phone.value.trim())){document.getElementById('group-phone').classList.add('invalid'); ok=false} else document.getElementById('group-phone').classList.remove('invalid');
      if(email.value && !(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value))){document.getElementById('group-email').classList.add('invalid'); ok=false} else document.getElementById('group-email').classList.remove('invalid');
      return ok;
    }

    function validatePage2(){
      let ok=true;
      const area=document.getElementById('area'), word=document.getElementById('word');
      if(!area.value.trim()){document.getElementById('group-area').classList.add('invalid'); ok=false} else document.getElementById('group-area').classList.remove('invalid');
      if(!word.value.trim()){document.getElementById('group-word').classList.add('invalid'); ok=false} else document.getElementById('group-word').classList.remove('invalid');
      return ok;
    }

    // IMPORTANT: Facebook must be provided and valid
    function validateForm(){
      if(!validatePage1()||!validatePage2()){showToast('Please fill required fields','error'); return}
      const facebook = document.getElementById('facebook');
      if(!facebook.value.trim()){document.getElementById('group-facebook').classList.add('invalid'); showToast('Facebook ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá','error'); return}
      try{
        new URL(facebook.value.trim());
        document.getElementById('group-facebook').classList.remove('invalid');
      }catch(e){
        document.getElementById('group-facebook').classList.add('invalid');
        showToast('‡¶∏‡¶†‡¶ø‡¶ï Facebook ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡¶®','error'); return;
      }
      submitForm();
    }

    // Submit: read photo (if any) -> save user -> push to telegram
    function submitForm(){
      const name=document.getElementById('name').value.trim();
      const phone=document.getElementById('phone').value.trim();
      const email=document.getElementById('email').value.trim();
      const area=document.getElementById('area').value.trim();
      const word=document.getElementById('word').value.trim();
      const facebook=document.getElementById('facebook').value.trim();
      const photoInput=document.getElementById('photo');

      const newUser = { id: Date.now(), name, phone, email, area, word, facebook, photo: '', status: 'pending', date: new Date().toLocaleString('bn-BD') };

      if(photoInput.files && photoInput.files[0]){
        const file = photoInput.files[0];
        if(!file.type.startsWith('image/')){showToast('Only image allowed','error'); return}
        if(file.size > 5*1024*1024){showToast('Image must be < 5MB','error'); return}
        const reader = new FileReader();
        reader.onload = function(e){
          newUser.photo = e.target.result; pushUser(newUser);
        }
        reader.readAsDataURL(file);
      } else {
        newUser.photo = null; pushUser(newUser);
      }
    }

    function pushUser(newUser){
      users.push(newUser); localStorage.setItem('users',JSON.stringify(users));
      if(isLoggedIn){ updateStats(); renderTable(); }
      sendRegistrationToTelegram(newUser);
      showSuccessAndReset();
    }

    function showSuccessAndReset(){
      document.getElementById('successMessage').style.display='block';
      setTimeout(()=>{document.getElementById('successMessage').style.display='none'},3500);
      document.getElementById('userForm').reset();
      document.getElementById('photoPreview').style.display='none';
      document.querySelectorAll('.form-page').forEach(p=>p.classList.remove('active'));
      document.getElementById('page1').classList.add('active');
      document.getElementById('formProgress').style.width='0%';
      updateStats();
    }

    // Preview & photo validations
    function handlePhotoChange(e){
      const file = e.target.files[0]; const preview = document.getElementById('photoPreview'); const err = document.getElementById('photoError');
      if(!file){ preview.style.display='none'; return }
      if(!file.type.startsWith('image/')){ err.textContent='‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§'; err.style.display='block'; e.target.value=''; preview.style.display='none'; return }
      if(file.size > 5*1024*1024){ err.textContent='‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∞ 5MB ‡¶è‡¶∞ ‡¶ï‡¶Æ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá'; err.style.display='block'; e.target.value=''; preview.style.display='none'; return }
      err.style.display='none'; const reader = new FileReader();
      reader.onload = function(ev){ preview.src = ev.target.result; preview.style.display='block' }; reader.readAsDataURL(file);
    }

    // Telegram integration (text + photo). NOTE: For production use server proxy.
    function sendRegistrationToTelegram(user){
      const message = `*BD Clean Jurain - New Registration*\nüë§ Name: ${user.name}\nüìû Phone: ${user.phone}\nüìç Area: ${user.area}\nüèò Word: ${user.word}\nüîó Facebook: ${user.facebook}\nüìÖ Date: ${user.date}`;
      // first send text for quick notification (optional)
      if(TELEGRAM_CONFIG.BOT_TOKEN && TELEGRAM_CONFIG.REGISTRATION_CHAT_ID){
        sendToTelegram(message, TELEGRAM_CONFIG.REGISTRATION_CHAT_ID);
      } else {
        console.log('Telegram not configured: message ->', message);
      }
      // if photo present send as photo with caption
      if(user.photo){
        if(TELEGRAM_CONFIG.BOT_TOKEN && TELEGRAM_CONFIG.REGISTRATION_CHAT_ID){
          sendPhotoToTelegram(user.photo, TELEGRAM_CONFIG.REGISTRATION_CHAT_ID, message);
        } else {
          console.log('Telegram not configured: photo available (not sent).');
        }
      }
    }

    function sendToTelegram(message, chatId){
      if(!TELEGRAM_CONFIG.BOT_TOKEN || !chatId){ console.log('Telegram not configured'); return; }
      fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'Markdown' })
      }).then(r=>r.json()).then(d=>console.log('telegram sendMessage',d)).catch(e=>console.error(e));
    }

    // Convert base64 image to Blob and send using sendPhoto
    function sendPhotoToTelegram(photoBase64, chatId, caption){
      if(!TELEGRAM_CONFIG.BOT_TOKEN || !chatId){ console.log('Telegram not configured'); return; }

      function b64toBlob(b64Data, contentType='', sliceSize=512){
        const byteCharacters = atob(b64Data.split(',')[1]);
        const byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
          const slice = byteCharacters.slice(offset, offset + sliceSize);
          const byteNumbers = new Array(slice.length);
          for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }
        return new Blob(byteArrays, {type: contentType});
      }

      const contentType = detectImageMime(photoBase64) || 'image/jpeg';
      const blob = b64toBlob(photoBase64, contentType);
      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('photo', blob, 'photo.jpg');
      if(caption) formData.append('caption', caption);
      formData.append('parse_mode', 'Markdown');

      fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      }).then(r=>r.json()).then(d=>console.log('telegram sendPhoto',d)).catch(e=>console.error('sendPhoto error',e));
    }

    function detectImageMime(b64){
      if(!b64) return null;
      const head = b64.split(',')[0];
      if(head.indexOf('image/png') !== -1) return 'image/png';
      if(head.indexOf('image/jpeg') !== -1) return 'image/jpeg';
      if(head.indexOf('image/webp') !== -1) return 'image/webp';
      return null;
    }

    // helpers
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];}); }

    // Initialize table from localStorage
    function initStorageRender(){
      // ensure users array exists
      users = JSON.parse(localStorage.getItem('users') || '[]');
      updateStats();
      if(isLoggedIn) renderTable();
    }

    // small helpers used earlier
    function saveUserToLocal(u){ users.push(u); localStorage.setItem('users',JSON.stringify(users)); }

    // Initialize on load
    window.onload = function(){ init(); initStorageRender(); }

  </script>
</body>
</html>
